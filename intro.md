# HTTP Live Streaming (HLS) 协议概述

## 1. 引言

HTTP Live Streaming（HLS）是由苹果公司开发的一种流媒体网络传输协议。它允许视频内容通过HTTP进行分发，特别适合互联网上的直播和点播服务。HLS的设计初衷是为了兼容广泛存在于网络上的HTTP缓存系统，使得视频可以高效地被传递到用户的设备上。随着HLS的普及，现在几乎所有主流的移动操作系统、智能电视和其他联网设备都支持这一协议。

## 2. HLS的工作原理

### 2.1 分段文件

HLS将视频或音频流分割成一系列小的HTTP资源，通常每个文件长度为2到10秒。这些分段文件可以是TS（MPEG-2 Transport Stream）格式或其他容器格式如MP4（使用fMP4 - fragmented MP4）。这种分段方法使得用户在观看时可以更快速地开始播放，同时减少了因为网络问题导致的缓冲。

### 2.2 播放列表

除了分段文件外，HLS还定义了.m3u8格式的播放列表文件，用于指示客户端如何获取和播放这些分段。播放列表包含了各个分段文件的位置信息，以及关于这些分段的元数据，例如持续时间、序列号等。对于直播流，服务器会不断更新播放列表以添加新的分段；而对于点播内容，播放列表则是一次性生成的。

### 2.3 自适应比特率（ABR）

HLS支持自适应比特率（Adaptive Bitrate, ABR），这意味着它可以提供多个不同质量级别的流。根据用户的网络状况和设备性能，播放器可以选择最适合当前条件的流来播放，从而保证最佳的观看体验。这通过创建多个版本的播放列表实现，每个版本对应一个不同的编码质量和分辨率。

## 3. HLS的优势

- **广泛兼容**：由于基于HTTP协议，HLS能够轻松穿越防火墙，并且与现有的Web服务器和CDN基础设施完全兼容。
- **跨平台支持**：从iOS、macOS到Android、Windows乃至各种OTT设备，HLS得到了广泛的支持。
- **错误恢复**：当遇到网络中断或其他故障时，HLS播放器可以尝试重新连接并继续播放未完成的部分。
- **安全性**：HLS可以通过AES-128加密来保护内容，确保只有授权用户才能访问流媒体。
- **实时性**：虽然HLS有固有的延迟（通常是几秒钟），但它仍然是实现实时直播的有效解决方案。

## 4. HLS的局限性

尽管HLS具有诸多优点，但也有其不足之处：

- **延迟较高**：相比于其他一些流媒体协议，如RTMP或WebRTC，HLS的延迟相对较大，这对于需要低延迟互动的应用场景可能不太理想。
- **复杂度增加**：为了实现ABR等功能，HLS增加了系统的复杂性，包括编码、打包、分发等多个环节。
- **带宽消耗**：在高并发情况下，如果所有用户都请求高清版本的流，可能会对服务器造成较大的带宽压力。

## 5. 基于Http的视频流


### 5.1 协议种类
[HLS](https://www.cloudflare.com/zh-cn/learning/video/what-is-http-live-streaming/)
[HDS](https://www.cloudflare.com/zh-cn/learning/video/what-is-http-dynamic-streaming/)
[MPEG-DASH](https://www.cloudflare.com/zh-cn/learning/video/what-is-mpeg-dash/)


### 5.2 HLS与HDS区别：
- **来源与标准化**：HLS是由苹果公司开发的专有协议，尽管它已被广泛采用，但并未成为国际标准。相反，HDS（HTTP Dynamic Streaming）是由Adobe公司开发的，并且也是专有的，没有成为广泛认可的国际标准。
- **内容与格式**：HLS主要支持视频和音频内容的分发，特别是与苹果设备兼容的H.264视频编码。HDS同样支持视频和音频内容的分发，但它最初是为Adobe的Flash技术设计的，支持包括H.264在内的多种视频编码格式。
- **播放器支持**：HLS得到了所有现代浏览器和移动设备（尤其是苹果设备）的支持。而HDS主要得到的是Adobe Flash Player的支持，随着HTML5和Flash技术的衰退，HDS的支持也在减少。
- **分发与适应性**：两者都支持自适应比特率流，允许根据用户的网络条件动态调整视频质量。但是，由于HLS的广泛采用，它通常拥有更好的跨平台和设备兼容性。
- **加密与安全性**：HLS支持通过AES-128加密来保护内容的安全性，而HDS也提供了类似的加密选项，但实现方式和细节可能有所不同。

请注意，由于HDS已经逐渐被淘汰，因此在实际应用中，HLS的使用更为普遍。

### 5.3 HLS 与 DASH区别

HLS 是当今另一种广泛使用的流式传输协议。MPEG-DASH 和 HLS 在许多方面相似。这两种协议都在 HTTP 上运行，使用TCP作为它们的传输协议，将视频分成带有随附索引文件的片段，并提供自适应比特率流式传输。

但是，这两种协议有几个关键区别：

* 编码格式： MPEG-DASH 允许使用任何编码标准。另一方面，HLS 需要使用H.264或 H.265。
* 设备支持： HLS 是唯一受 Apple 设备支持的格式。iPhone、MacBook 和其他 Apple 产品无法播放通过 MPEG-DASH 传输的视频。
* 片段长度：这是 2016 年以前协议之间的较大差异，当时 HLS 的默认片段长度为 10 秒。今天，HLS 的默认长度为 6 秒，但可以调整。MPEG-DASH 片段的长度通常在 2 到 10 秒之间，但最佳长度是 2 到 4 秒。
* 标准化： MPEG-DASH 是一种国际标准。HLS 由 Apple 开发，尽管得到了广泛的支持，并没有发布为国际标准。

### 5.4 HLS与DASH的延时对比

HLS和DASH都存在一定的延时问题，但它们在延时方面的表现有所不同。以下是两者延时对比的一些关键点：

* **协议设计**：HLS和DASH都基于HTTP协议，但DASH在设计上更加灵活，允许更小的片段长度，这有助于减少延时。
* **默认片段长度**：如前所述，HLS的默认片段长度为6秒（尽管可以调整），而DASH的片段长度通常在2到4秒之间，更短的片段意味着更快的切换速度和更低的延时。
* **缓冲时间**：播放器在开始播放之前需要缓冲一定数量的片段。由于DASH支持更小的片段，因此缓冲时间通常比HLS短。
* **网络状况**：在网络状况不佳的情况下，HLS可能需要重新加载整个播放列表，而DASH则可以更快地适应变化的网络条件。
* **实时互动**：对于需要低延时互动的应用场景（如在线游戏、实时聊天等），DASH通常比HLS更具优势。

然而，需要注意的是，尽管DASH在延时方面表现更好，但HLS在设备兼容性和跨平台支持方面仍然具有优势。因此，在选择流媒体协议时，需要根据具体应用场景和需求进行权衡。
